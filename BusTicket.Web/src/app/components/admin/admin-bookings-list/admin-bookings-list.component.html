<div class="bookings-container">
  <div class="header">
    <div class="header-content">
      <div class="header-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
      </div>
      <div>
        <h1>Bookings Management</h1>
        <p>View and manage all customer bookings</p>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon confirmed">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getConfirmedCount() }}</div>
        <div class="stat-label">Confirmed</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon pending">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getPendingCount() }}</div>
        <div class="stat-label">Pending</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon cancelled">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getCancelledCount() }}</div>
        <div class="stat-label">Cancelled</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon total">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">৳{{ getTotalFare().toLocaleString() }}</div>
        <div class="stat-label">Total Revenue</div>
      </div>
    </div>
  </div>

  <!-- Filters Panel -->
  <div class="filters-card">
    <div class="filters-header">
      <h3>Filters</h3>
      <button class="btn-text" (click)="clearFilters()">Clear All</button>
    </div>
    
    <div class="filters-grid">
      <!-- Company Filter -->
      <div class="filter-group">
        <label for="companyFilter">Company</label>
        <select id="companyFilter" [(ngModel)]="selectedCompanyId">
          <option value="">All Companies</option>
          <option *ngFor="let company of companies" [value]="company.id">
            {{ company.name }}
          </option>
        </select>
      </div>

      <!-- Status Filter -->
      <div class="filter-group">
        <label for="statusFilter">Status</label>
        <select id="statusFilter" [(ngModel)]="selectedBookingStatus">
          <option value="">All Statuses</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Pending">Pending</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>

      <!-- Journey Date From -->
      <div class="filter-group">
        <label for="journeyDateFrom">Journey From</label>
        <input type="date" id="journeyDateFrom" [(ngModel)]="journeyDateFrom" />
      </div>

      <!-- Journey Date To -->
      <div class="filter-group">
        <label for="journeyDateTo">Journey To</label>
        <input type="date" id="journeyDateTo" [(ngModel)]="journeyDateTo" />
      </div>

      <!-- Booking Date From -->
      <div class="filter-group">
        <label for="bookingDateFrom">Booked From</label>
        <input type="date" id="bookingDateFrom" [(ngModel)]="bookingDateFrom" />
      </div>

      <!-- Booking Date To -->
      <div class="filter-group">
        <label for="bookingDateTo">Booked To</label>
        <input type="date" id="bookingDateTo" [(ngModel)]="bookingDateTo" />
      </div>

      <!-- Search Term -->
      <div class="filter-group filter-search">
        <label for="searchTerm">Search</label>
        <input 
          type="text" 
          id="searchTerm" 
          [(ngModel)]="searchTerm" 
          placeholder="Ticket, Name, or Phone" 
        />
      </div>

      <!-- Apply Button -->
      <div class="filter-group filter-button">
        <button class="btn-primary" (click)="applyFilters()" [disabled]="isLoading">
          {{ isLoading ? 'Loading...' : 'Apply Filters' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="alert alert-error" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <!-- Bookings Table -->
  <div class="table-card">
    <div *ngIf="isLoading" class="loading">
      <div class="spinner"></div>
      <p>Loading bookings...</p>
    </div>

    <div *ngIf="!isLoading && filteredBookings.length === 0" class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
      </svg>
      <h3>No bookings found</h3>
      <p>Try adjusting your filters or check back later.</p>
    </div>

    <div *ngIf="!isLoading && filteredBookings.length > 0" class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Ticket #</th>
            <th>Passenger</th>
            <th>Company / Bus</th>
            <th>Route</th>
            <th>Journey</th>
            <th>Seat</th>
            <th>Fare</th>
            <th>Booked</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let booking of filteredBookings">
            <td>
              <span class="ticket-number">{{ booking.ticketNumber }}</span>
            </td>
            <td>
              <div class="passenger-info">
                <div class="passenger-name">{{ booking.passengerName }}</div>
                <div class="passenger-contact">{{ booking.phoneNumber }}</div>
              </div>
            </td>
            <td>
              <div class="bus-info">
                <div class="company-name">{{ booking.companyName }}</div>
                <div class="bus-details">{{ booking.busNumber }} - {{ booking.busName }}</div>
              </div>
            </td>
            <td>
              <div class="route-info">
                <span class="city">{{ booking.fromCity }}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
                <span class="city">{{ booking.toCity }}</span>
              </div>
            </td>
            <td>
              <div class="journey-info">
                <div class="journey-date">{{ formatDate(booking.journeyDate) }}</div>
                <div class="journey-time">{{ formatTime(booking.departureTime) }}</div>
              </div>
            </td>
            <td>
              <span class="seat-badge">{{ booking.seatNumber }}</span>
            </td>
            <td>
              <span class="fare-badge">৳{{ booking.fare }}</span>
            </td>
            <td>
              <span class="booking-date">{{ formatDateTime(booking.bookingDate) }}</span>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(booking.bookingStatus)">
                {{ booking.bookingStatus }}
              </span>
            </td>
            <td>
              <div class="payment-status">
                <span class="badge" *ngIf="hasPayment(booking.ticketId)" 
                      [ngClass]="{'bg-success': true}">
                  Paid
                </span>
                <span class="badge bg-warning" *ngIf="!hasPayment(booking.ticketId) && booking.isConfirmed">
                  Unpaid
                </span>
                <span class="badge bg-secondary" *ngIf="!hasPayment(booking.ticketId) && !booking.isConfirmed && !booking.isCancelled">
                  Pending
                </span>
                <span class="badge bg-secondary" *ngIf="booking.isCancelled">
                  N/A
                </span>
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon" (click)="showDetails(booking)" title="View Details">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
                <button class="btn-icon btn-success" 
                        *ngIf="!hasPayment(booking.ticketId) && booking.isConfirmed && !booking.isCancelled"
                        (click)="processPayment(booking)" 
                        title="Process Payment">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                  </svg>
                </button>
                <button class="btn-icon btn-info" 
                        *ngIf="hasPayment(booking.ticketId)"
                        (click)="viewReceipt(booking)" 
                        title="View Receipt">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Booking Details</h2>
      <button class="btn-close" (click)="closeDetailsModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedBooking">
      <div class="detail-section">
        <h3>Ticket Information</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Ticket Number:</span>
            <span class="detail-value ticket-number">{{ selectedBooking.ticketNumber }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Status:</span>
            <span class="status-badge" [ngClass]="getStatusClass(selectedBooking.bookingStatus)">
              {{ selectedBooking.bookingStatus }}
            </span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h3>Passenger Information</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Name:</span>
            <span class="detail-value">{{ selectedBooking.passengerName }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Phone:</span>
            <span class="detail-value">{{ selectedBooking.phoneNumber }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Email:</span>
            <span class="detail-value">{{ selectedBooking.email }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h3>Journey Details</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Company:</span>
            <span class="detail-value">{{ selectedBooking.companyName }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Bus:</span>
            <span class="detail-value">{{ selectedBooking.busNumber }} - {{ selectedBooking.busName }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Route:</span>
            <span class="detail-value">{{ selectedBooking.fromCity }} → {{ selectedBooking.toCity }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Journey Date:</span>
            <span class="detail-value">{{ formatDate(selectedBooking.journeyDate) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Departure:</span>
            <span class="detail-value">{{ formatTime(selectedBooking.departureTime) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Seat:</span>
            <span class="seat-badge">{{ selectedBooking.seatNumber }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h3>Booking & Payment</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Booked On:</span>
            <span class="detail-value">{{ formatDateTime(selectedBooking.bookingDate) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Fare:</span>
            <span class="fare-badge">৳{{ selectedBooking.fare }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedBooking.confirmationDate">
            <span class="detail-label">Confirmed On:</span>
            <span class="detail-value">{{ formatDateTime(selectedBooking.confirmationDate!) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Payment Status:</span>
            <span class="badge" 
                  [ngClass]="{
                    'bg-success': hasPayment(selectedBooking.ticketId),
                    'bg-warning': !hasPayment(selectedBooking.ticketId) && selectedBooking.isConfirmed,
                    'bg-secondary': !hasPayment(selectedBooking.ticketId) && !selectedBooking.isConfirmed
                  }">
              {{ getPaymentStatus(selectedBooking) }}
            </span>
          </div>
        </div>
        
        <!-- Payment action button -->
        <div class="mt-3" *ngIf="!hasPayment(selectedBooking.ticketId) && selectedBooking.isConfirmed && !selectedBooking.isCancelled">
          <button class="btn btn-primary btn-sm" (click)="processPayment(selectedBooking); closeDetailsModal()">
            <i class="bi bi-credit-card me-2"></i>
            Process Payment
          </button>
        </div>
        <div class="mt-3" *ngIf="hasPayment(selectedBooking.ticketId)">
          <button class="btn btn-outline-primary btn-sm" (click)="viewReceipt(selectedBooking); closeDetailsModal()">
            <i class="bi bi-receipt me-2"></i>
            View Receipt
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal-overlay" *ngIf="showPaymentModal" (click)="closePaymentModal()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Process Payment</h2>
      <button class="btn-close" (click)="closePaymentModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <div class="modal-body">
      <app-payment-processing
        [ticketId]="paymentTicketId"
        [amount]="paymentAmount"
        [customerEmail]="paymentEmail"
        (paymentCompleted)="onPaymentCompleted($event)"
        (paymentFailed)="onPaymentFailed($event)"
        (cancelled)="onPaymentCancelled()">
      </app-payment-processing>
    </div>
  </div>
</div>

<!-- Receipt Modal -->
<div class="modal-overlay" *ngIf="showReceiptModal" (click)="closeReceiptModal()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Payment Receipt</h2>
      <button class="btn-close" (click)="closeReceiptModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <div class="modal-body">
      <app-payment-receipt *ngIf="paymentReceipt" [payment]="paymentReceipt">
      </app-payment-receipt>
    </div>
  </div>
</div>
